name: æ¯æ—¥æ„å»º MSM

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 4 ç‚¹ï¼ˆUTC æ—¶é—´ 20:00ï¼Œå³åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹ï¼‰
    - cron: '0 20 * * *'
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦æ„å»ºçš„åˆ†æ”¯'
        required: false
        default: 'main'
        type: string

permissions:
  contents: write

concurrency:
  group: daily-build-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.meta.outputs.version }}
      commit_sha: ${{ steps.meta.outputs.commit_sha }}
      commit_sha_short: ${{ steps.meta.outputs.commit_sha_short }}
      branch: ${{ steps.meta.outputs.branch }}
      changelog: ${{ steps.meta.outputs.changelog }}
      commit_message: ${{ steps.meta.outputs.commit_message }}
      commit_author: ${{ steps.meta.outputs.commit_author }}
      commit_date: ${{ steps.meta.outputs.commit_date }}
    steps:
      - name: Checkout MSM ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: msm9527/msm
          ref: ${{ inputs.branch || 'main' }}
          token: ${{ secrets.MSM_REPO_TOKEN }}
          fetch-depth: 0

      - name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          VERSION="$(sed -nE 's/^[[:space:]]*version[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/p' backend/cmd/msm/commands/root.go | head -n 1)"
          if [ -z "${VERSION}" ]; then
            echo "error: æ— æ³•ä» backend/cmd/msm/commands/root.go è§£æç‰ˆæœ¬å·" >&2
            exit 1
          fi

          COMMIT_SHA="$(git rev-parse HEAD)"
          COMMIT_SHA_SHORT="$(git rev-parse --short=7 HEAD)"
          BRANCH="${{ inputs.branch || 'main' }}"

          # è·å–æœ€æ–°æäº¤ä¿¡æ¯
          COMMIT_MESSAGE="$(git log -1 --pretty=format:'%s')"
          COMMIT_AUTHOR="$(git log -1 --pretty=format:'%an')"
          COMMIT_DATE="$(git log -1 --pretty=format:'%ci')"

          # è·å–æœ€è¿‘ 10 æ¡æäº¤è®°å½•ï¼Œæ ¼å¼åŒ–ä¸º markdown
          CHANGELOG="$(git log -10 --pretty=format:'- [%h](https://github.com/msm9527/msm/commit/%H) %s _%an, %ar_' | sed 's/$/\\n/' | tr -d '\n')"

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "commit_sha=${COMMIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "commit_sha_short=${COMMIT_SHA_SHORT}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "commit_message=${COMMIT_MESSAGE}" >> "$GITHUB_OUTPUT"
          echo "commit_author=${COMMIT_AUTHOR}" >> "$GITHUB_OUTPUT"
          echo "commit_date=${COMMIT_DATE}" >> "$GITHUB_OUTPUT"

          {
            echo "changelog<<EOF"
            echo "${CHANGELOG}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "æ„å»ºç‰ˆæœ¬: ${VERSION}"
          echo "æ„å»ºåˆ†æ”¯: ${BRANCH}"
          echo "æäº¤ SHA: ${COMMIT_SHA}"
          echo "æœ€æ–°æäº¤: ${COMMIT_MESSAGE}"

  build:
    name: æ‰“åŒ…ç¼–è¯‘
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-amd64
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
          - target: linux-amd64-musl
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
          - target: linux-arm64
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm64
          - target: linux-arm64-musl
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm64
          - target: linux-armv7
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm
            goarm: "7"
          - target: linux-armv6
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm
            goarm: "6"
          - target: linux-386
            runs_on: ubuntu-24.04
            goos: linux
            goarch: "386"
          - target: darwin-amd64
            runs_on: macos-15-intel
            goos: darwin
            goarch: amd64
          - target: darwin-arm64
            runs_on: macos-15
            goos: darwin
            goarch: arm64
    runs-on: ${{ matrix.runs_on }}
    steps:
      - name: Checkout MSM ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: msm9527/msm
          ref: ${{ inputs.branch || 'main' }}
          token: ${{ secrets.MSM_REPO_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"
          check-latest: true
          cache: true
          cache-dependency-path: backend/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: æ„å»º supervisordï¼ˆåµŒå…¥èµ„æºï¼‰
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm || '' }}
          CGO_ENABLED: ${{ matrix.goos == 'darwin' && '1' || '0' }}
        run: |
          set -euo pipefail
          SUPERVISORD_COMMIT="$(head -n 1 backend/cmd/msm/.supervisord.version | tr -d '\r\n')"
          if [ -z "${SUPERVISORD_COMMIT}" ]; then
            echo "error: backend/cmd/msm/.supervisord.version ä¸ºç©º" >&2
            exit 1
          fi
          echo "supervisord commit: ${SUPERVISORD_COMMIT}"

          rm -rf /tmp/supervisord
          git clone https://github.com/ochinchina/supervisord.git /tmp/supervisord
          git -C /tmp/supervisord checkout "${SUPERVISORD_COMMIT}"

          (cd /tmp/supervisord && go build -ldflags="-s -w" -o supervisord)
          cp /tmp/supervisord/supervisord backend/cmd/msm/supervisord

      - name: æ„å»ºå‰ç«¯å¹¶å¤åˆ¶åˆ°åç«¯ï¼ˆåµŒå…¥èµ„æºï¼‰
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          npm ci --no-audit --no-fund
          npm run build

          test -d dist

          rm -rf ../backend/cmd/msm/frontend/dist
          mkdir -p ../backend/cmd/msm/frontend
          cp -r dist ../backend/cmd/msm/frontend/

      - name: ç¼–è¯‘ MSMï¼ˆäºŒè¿›åˆ¶ä¼˜åŒ–ç‰ˆï¼‰
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm || '' }}
          CGO_ENABLED: ${{ matrix.goos == 'darwin' && '1' || '0' }}
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p dist
          cd backend
          go build -ldflags="-s -w" -o ../dist/msm ./cmd/msm
          cd ..
          chmod +x dist/msm

          # macOS éœ€è¦ä¿ç•™äºŒè¿›åˆ¶ç”¨äº Tauri æ„å»ºï¼Œç¨åå†æ‰“åŒ…
          if [ "${{ matrix.goos }}" != "darwin" ]; then
            tar -czf "dist/msm-${VERSION}-${{ matrix.target }}.tar.gz" -C dist msm
            rm -f dist/msm
          fi

      # macOS æ¡Œé¢åº”ç”¨æ„å»º
      - name: Setup Rust (macOS only)
        if: matrix.goos == 'darwin'
        uses: dtolnay/rust-toolchain@stable

      - name: æ„å»º Tauri æ¡Œé¢åº”ç”¨ (macOS only)
        if: matrix.goos == 'darwin'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"

          export TAURI_APP_VERSION="${VERSION}"
          export TAURI_BUILD_VERSION="${VERSION}"

          cd frontend

          # å®‰è£…å‰ç«¯ä¾èµ–ï¼ˆç¡®ä¿ Tauri æ„å»ºç¯å¢ƒï¼‰
          npm ci --no-audit --no-fund

          WORKSPACE="$PWD"
          SRC_TAURI_DIR="$WORKSPACE/src-tauri"
          DIST_ROOT="$WORKSPACE/../dist"

          # ç¡®ä¿ç›®å½•å­˜åœ¨ï¼›å¦‚å­˜åœ¨å¼€å‘ç”¨çš„ msm å¯æ‰§è¡Œæ–‡ä»¶ç¬¦å·é“¾æ¥ï¼Œå…ˆç§»é™¤å†åˆ›å»ºç›®å½•
          mkdir -p "$SRC_TAURI_DIR"
          if [ -e "$SRC_TAURI_DIR/msm" ] || [ -L "$SRC_TAURI_DIR/msm" ]; then
            rm -rf "$SRC_TAURI_DIR/msm"
          fi
          mkdir -p "$SRC_TAURI_DIR/msm"

          # ç›´æ¥å¤åˆ¶å·²ç¼–è¯‘çš„äºŒè¿›åˆ¶åˆ° src-tauri/msm
          cp "$DIST_ROOT/msm" "$SRC_TAURI_DIR/msm"
          chmod +x "$SRC_TAURI_DIR/msm"

          # å¤åˆ¶å¿…è¦çš„èµ„æºæ–‡ä»¶
          cp about.html dist/ || true
          cp icon.png dist/ || true

          # ä¸´æ—¶ä¿®æ”¹ tauri.conf.jsonï¼Œè·³è¿‡ beforeBuildCommandï¼ˆå‰ç«¯å·²æ„å»ºï¼‰
          TAURI_CONF="$SRC_TAURI_DIR/tauri.conf.json"
          cp "$TAURI_CONF" "$TAURI_CONF.backup"
          sed -i.tmp 's/"beforeBuildCommand":[^,]*,/"beforeBuildCommand": "echo Skipping frontend build",/' "$TAURI_CONF"

          # ä½¿ç”¨ Tauri æ„å»º DMG
          npm run tauri build

          # æ¢å¤åŸå§‹é…ç½®
          mv "$TAURI_CONF.backup" "$TAURI_CONF"

          # å¤åˆ¶ DMG åˆ° dist ç›®å½•
          mkdir -p "$DIST_ROOT"
          cp "$SRC_TAURI_DIR/target/release/bundle/dmg"/*.dmg "$DIST_ROOT/msm-desktop-${VERSION}-${{ matrix.target }}.dmg"

          # æ‰“åŒ…äºŒè¿›åˆ¶ tar.gz
          cd "$DIST_ROOT"
          tar -czf "msm-${VERSION}-${{ matrix.target }}.tar.gz" msm
          rm -f msm

          ls -l "$DIST_ROOT"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© - äºŒè¿›åˆ¶ (macOS)
        if: matrix.goos == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist/msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.tar.gz
          if-no-files-found: error

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© - DMG (macOS)
        if: matrix.goos == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: msm-desktop-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist/msm-desktop-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.dmg
          if-no-files-found: error

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Linux)
        if: matrix.goos != 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist/msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.tar.gz
          if-no-files-found: error

  release:
    name: å‘å¸ƒæ¯æ—¥æ„å»º
    needs: [prepare, build]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout å½“å‰ä»“åº“ï¼ˆmsm-wikiï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: åˆ›å»º/æ›´æ–°ç‰ˆæœ¬ tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          SHA="${GITHUB_SHA}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ é™¤æ—§çš„ç‰ˆæœ¬ tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git tag -d "${VERSION}" >/dev/null 2>&1 || true
          git push origin ":refs/tags/${VERSION}" || true

          # åˆ›å»ºæ–°çš„ç‰ˆæœ¬ tag
          git tag -a "${VERSION}" -m "æ¯æ—¥æ„å»º ${VERSION}" "${SHA}"
          git push origin "refs/tags/${VERSION}"

      - name: åˆ›å»º/æ›´æ–° GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.prepare.outputs.version }}
          name: ğŸš€ MSM ${{ needs.prepare.outputs.version }}
          body: |
            ## ğŸ“¦ æ¯æ—¥è‡ªåŠ¨æ„å»ºç‰ˆæœ¬

            > æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºï¼ŒåŒ…å«æœ€æ–°çš„ä»£ç æ›´æ–°ã€‚

            ### ğŸ“‹ æ„å»ºä¿¡æ¯

            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | **ç‰ˆæœ¬å·** | `${{ needs.prepare.outputs.version }}` |
            | **æºä»“åº“** | [msm9527/msm](https://github.com/msm9527/msm) |
            | **æ„å»ºåˆ†æ”¯** | `${{ needs.prepare.outputs.branch }}` ğŸŒ¿ |
            | **æºæäº¤** | [`${{ needs.prepare.outputs.commit_sha_short }}`](https://github.com/msm9527/msm/commit/${{ needs.prepare.outputs.commit_sha }}) |
            | **æ„å»ºæ—¶é—´** | ${{ github.event.repository.updated_at }} â° |

            ### ğŸ¯ æœ€æ–°æäº¤

            **${{ needs.prepare.outputs.commit_message }}**

            - ğŸ‘¤ ä½œè€…: ${{ needs.prepare.outputs.commit_author }}
            - ğŸ“… æ—¶é—´: ${{ needs.prepare.outputs.commit_date }}
            - ğŸ”— é“¾æ¥: https://github.com/msm9527/msm/commit/${{ needs.prepare.outputs.commit_sha }}

            ---

            ### ğŸ“ è¿‘æœŸæ›´æ–°è®°å½•ï¼ˆæœ€è¿‘ 10 æ¬¡æäº¤ï¼‰

            ${{ needs.prepare.outputs.changelog }}

            ---

            ### ğŸ’¾ æ”¯æŒçš„å¹³å°

            #### å‘½ä»¤è¡Œç‰ˆæœ¬ï¼ˆCLIï¼‰

            | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
            |------|------|------|
            | ğŸ§ Linux | amd64 (glibc) | `msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz` |
            | ğŸ§ Linux | amd64 (musl/Alpine) | `msm-${{ needs.prepare.outputs.version }}-linux-amd64-musl.tar.gz` |
            | ğŸ§ Linux | arm64 (glibc) | `msm-${{ needs.prepare.outputs.version }}-linux-arm64.tar.gz` |
            | ğŸ§ Linux | arm64 (musl/Alpine) | `msm-${{ needs.prepare.outputs.version }}-linux-arm64-musl.tar.gz` |
            | ğŸ§ Linux | armv7 | `msm-${{ needs.prepare.outputs.version }}-linux-armv7.tar.gz` |
            | ğŸ§ Linux | armv6 | `msm-${{ needs.prepare.outputs.version }}-linux-armv6.tar.gz` |
            | ğŸ§ Linux | 386 | `msm-${{ needs.prepare.outputs.version }}-linux-386.tar.gz` |
            | ğŸ macOS | amd64 (Intel) | `msm-${{ needs.prepare.outputs.version }}-darwin-amd64.tar.gz` |
            | ğŸ macOS | arm64 (Apple Silicon) | `msm-${{ needs.prepare.outputs.version }}-darwin-arm64.tar.gz` |

            #### æ¡Œé¢åº”ç”¨ç‰ˆæœ¬ï¼ˆDesktopï¼‰

            | å¹³å° | æ¶æ„ | æ–‡ä»¶ |
            |------|------|------|
            | ğŸ macOS | amd64 (Intel) | `msm-desktop-${{ needs.prepare.outputs.version }}-darwin-amd64.dmg` |
            | ğŸ macOS | arm64 (Apple Silicon) | `msm-desktop-${{ needs.prepare.outputs.version }}-darwin-arm64.dmg` |

            ### ğŸš€ å¿«é€Ÿå®‰è£…

            #### å‘½ä»¤è¡Œç‰ˆæœ¬ï¼ˆCLIï¼‰

            ```bash
            # ä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰
            curl -fsSL https://raw.githubusercontent.com/msm9527/msm-wiki/main/install.sh | sudo bash

            # æˆ–æ‰‹åŠ¨ä¸‹è½½å¹¶å®‰è£…ï¼ˆä»¥ Linux amd64 ä¸ºä¾‹ï¼‰
            wget https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz
            tar -xzf msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz
            sudo mv msm /usr/local/bin/msm
            sudo chmod +x /usr/local/bin/msm
            ```

            #### æ¡Œé¢åº”ç”¨ç‰ˆæœ¬ï¼ˆDesktopï¼‰

            **macOS ç”¨æˆ·ï¼š**

            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ DMG æ–‡ä»¶ï¼š
               - Intel èŠ¯ç‰‡ï¼š`msm-desktop-${{ needs.prepare.outputs.version }}-darwin-amd64.dmg`
               - Apple Silicon (M1/M2/M3)ï¼š`msm-desktop-${{ needs.prepare.outputs.version }}-darwin-arm64.dmg`

            2. åŒå‡» DMG æ–‡ä»¶ï¼Œå°†åº”ç”¨æ‹–å…¥ Applications æ–‡ä»¶å¤¹

            3. é¦–æ¬¡æ‰“å¼€æ—¶ï¼Œå¦‚æœé‡åˆ°"æ— æ³•éªŒè¯å¼€å‘è€…"æç¤ºï¼š
               - æ‰“å¼€"ç³»ç»Ÿè®¾ç½®" â†’ "éšç§ä¸å®‰å…¨æ€§"
               - ç‚¹å‡»"ä»è¦æ‰“å¼€"æŒ‰é’®

            ### ğŸ“š æ–‡æ¡£

            - ğŸ“– [å®Œæ•´æ–‡æ¡£](https://msm9527.github.io/msm-wiki/)
            - ğŸš€ [å¿«é€Ÿå¼€å§‹](https://msm9527.github.io/msm-wiki/zh/guide/getting-started.html)
            - ğŸ’¾ [å®‰è£…éƒ¨ç½²](https://msm9527.github.io/msm-wiki/zh/guide/install.html)

            ---

            <sub>ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨æ„å»ºäº ${{ github.event.repository.updated_at }}</sub>
          makeLatest: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: |
            dist/**/msm-${{ needs.prepare.outputs.version }}-*.tar.gz
            dist/**/msm-desktop-${{ needs.prepare.outputs.version }}-*.dmg

  docker:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    needs: [prepare, release]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: å‡†å¤‡å„æ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"

          # åˆ›å»ºç›®å½•ç»“æ„ binaries/{platform}/msm
          mkdir -p binaries/linux/amd64 binaries/linux/arm64 binaries/linux/arm/v7 binaries/linux/arm/v6 binaries/linux/386

          # è§£å‹å¹¶å¤åˆ¶å„æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
          echo "å‡†å¤‡ linux/amd64 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-amd64/msm-${VERSION}-linux-amd64.tar.gz" -C binaries/linux/amd64

          echo "å‡†å¤‡ linux/arm64 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-arm64/msm-${VERSION}-linux-arm64.tar.gz" -C binaries/linux/arm64

          echo "å‡†å¤‡ linux/arm/v7 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-armv7/msm-${VERSION}-linux-armv7.tar.gz" -C binaries/linux/arm/v7

          echo "å‡†å¤‡ linux/arm/v6 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-armv6/msm-${VERSION}-linux-armv6.tar.gz" -C binaries/linux/arm/v6

          echo "å‡†å¤‡ linux/386 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-386/msm-${VERSION}-linux-386.tar.gz" -C binaries/linux/386

          # éªŒè¯æ–‡ä»¶ç»“æ„
          echo "éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶:"
          find binaries -name msm -exec ls -lh {} \;

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€å¤šæ¶æ„ Docker é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.binary
          platforms: linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6,linux/386
          push: true
          tags: msmbox/msm:${{ needs.prepare.outputs.version }},msmbox/msm:latest
          labels: |
            org.opencontainers.image.title=MSM
            org.opencontainers.image.description=Mosdns Singbox Mihomo Manager
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.source=https://github.com/msm9527/msm
            org.opencontainers.image.url=https://msm9527.github.io/msm-wiki/
          provenance: false
          sbom: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=image,push=true

      - name: æ˜¾ç¤ºé•œåƒä¿¡æ¯
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "âœ… Docker é•œåƒå·²æ¨é€åˆ° Docker Hub"
          echo ""
          echo "é•œåƒæ ‡ç­¾:"
          echo "  - msmbox/msm:${VERSION}"
          echo "  - msmbox/msm:latest"
          echo ""
          echo "æ”¯æŒçš„æ¶æ„:"
          echo "  - linux/amd64"
          echo "  - linux/arm64"
          echo "  - linux/arm/v7"
          echo "  - linux/arm/v6"
          echo "  - linux/386"
          echo ""
          echo "ä½¿ç”¨æ–¹å¼:"
          echo "  docker pull msmbox/msm:latest"
          echo "  docker run -d -p 7777:7777 msmbox/msm:latest"
