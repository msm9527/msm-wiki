name: æ¯æ—¥æ„å»º MSM

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 4 ç‚¹ï¼ˆUTC æ—¶é—´ 20:00ï¼Œå³åŒ—äº¬æ—¶é—´å‡Œæ™¨ 4 ç‚¹ï¼‰
    - cron: '0 20 * * *'
  workflow_dispatch:
    inputs:
      branch:
        description: 'è¦æ„å»ºçš„åˆ†æ”¯'
        required: false
        default: 'main'
        type: string

permissions:
  contents: write

concurrency:
  group: daily-build-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: å‡†å¤‡æ„å»ºä¿¡æ¯
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.meta.outputs.version }}
      commit_sha: ${{ steps.meta.outputs.commit_sha }}
      commit_sha_short: ${{ steps.meta.outputs.commit_sha_short }}
      branch: ${{ steps.meta.outputs.branch }}
      changelog: ${{ steps.meta.outputs.changelog }}
      commit_message: ${{ steps.meta.outputs.commit_message }}
      commit_author: ${{ steps.meta.outputs.commit_author }}
      commit_date: ${{ steps.meta.outputs.commit_date }}
      previous_tag: ${{ steps.meta.outputs.previous_tag }}
      commit_count: ${{ steps.meta.outputs.commit_count }}
      ai_summary: ${{ steps.ai_summary.outputs.summary }}
    steps:
      - name: Checkout MSM ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: msm9527/msm
          ref: ${{ inputs.branch || 'main' }}
          token: ${{ secrets.MSM_REPO_TOKEN }}
          fetch-depth: 0

      - name: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
        id: meta
        shell: bash
        run: |
          set -euo pipefail

          VERSION="$(sed -nE 's/^[[:space:]]*version[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/p' backend/cmd/msm/commands/root.go | head -n 1)"
          if [ -z "${VERSION}" ]; then
            echo "error: æ— æ³•ä» backend/cmd/msm/commands/root.go è§£æç‰ˆæœ¬å·" >&2
            exit 1
          fi

          COMMIT_SHA="$(git rev-parse HEAD)"
          COMMIT_SHA_SHORT="$(git rev-parse --short=7 HEAD)"
          BRANCH="${{ inputs.branch || 'main' }}"

          # è·å–æœ€æ–°æäº¤ä¿¡æ¯
          COMMIT_MESSAGE="$(git log -1 --pretty=format:'%s')"
          COMMIT_AUTHOR="$(git log -1 --pretty=format:'%an')"
          COMMIT_DATE="$(git log -1 --pretty=format:'%ci')"

          # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ tagï¼ˆç”¨äºç¡®å®šæäº¤èŒƒå›´ï¼‰
          PREVIOUS_TAG="$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo '')"

          # å¦‚æœæ‰¾åˆ°ä¸Šä¸€ä¸ª tagï¼Œè·å–ä»ä¸Šä¸ªç‰ˆæœ¬åˆ°å½“å‰çš„æ‰€æœ‰æäº¤
          # å¦åˆ™è·å–æœ€è¿‘ 20 æ¡æäº¤
          if [ -n "${PREVIOUS_TAG}" ]; then
            echo "æ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬: ${PREVIOUS_TAG}"
            CHANGELOG="$(git log ${PREVIOUS_TAG}..HEAD --pretty=format:'- [%h](https://github.com/msm9527/msm/commit/%H) %s _%an, %ar_' | sed 's/$/\\n/' | tr -d '\n')"
            COMMIT_COUNT="$(git rev-list --count ${PREVIOUS_TAG}..HEAD)"
          else
            echo "æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œä½¿ç”¨æœ€è¿‘ 20 æ¡æäº¤"
            CHANGELOG="$(git log -20 --pretty=format:'- [%h](https://github.com/msm9527/msm/commit/%H) %s _%an, %ar_' | sed 's/$/\\n/' | tr -d '\n')"
            COMMIT_COUNT="20"
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "commit_sha=${COMMIT_SHA}" >> "$GITHUB_OUTPUT"
          echo "commit_sha_short=${COMMIT_SHA_SHORT}" >> "$GITHUB_OUTPUT"
          echo "branch=${BRANCH}" >> "$GITHUB_OUTPUT"
          echo "commit_message=${COMMIT_MESSAGE}" >> "$GITHUB_OUTPUT"
          echo "commit_author=${COMMIT_AUTHOR}" >> "$GITHUB_OUTPUT"
          echo "commit_date=${COMMIT_DATE}" >> "$GITHUB_OUTPUT"
          echo "previous_tag=${PREVIOUS_TAG}" >> "$GITHUB_OUTPUT"
          echo "commit_count=${COMMIT_COUNT}" >> "$GITHUB_OUTPUT"

          {
            echo "changelog<<EOF"
            echo "${CHANGELOG}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          echo "æ„å»ºç‰ˆæœ¬: ${VERSION}"
          echo "æ„å»ºåˆ†æ”¯: ${BRANCH}"
          echo "æäº¤ SHA: ${COMMIT_SHA}"
          echo "æœ€æ–°æäº¤: ${COMMIT_MESSAGE}"
          echo "æäº¤æ•°é‡: ${COMMIT_COUNT}"

      - name: ä½¿ç”¨ AI ç”Ÿæˆç‰ˆæœ¬æ€»ç»“
        id: ai_summary
        uses: actions/github-script@v7
        env:
          MODELSCOPE_API_KEY: ${{ secrets.MODELSCOPE_API_KEY }}
        with:
          script: |
            const { execSync } = require('child_process');

            // è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬ tag
            const previousTag = '${{ steps.meta.outputs.previous_tag }}';
            const commitCount = parseInt('${{ steps.meta.outputs.commit_count }}');

            // æ ¹æ®æ˜¯å¦æœ‰ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œè·å–ç›¸åº”èŒƒå›´çš„æäº¤è®°å½•
            let gitLogCmd;
            if (previousTag) {
              console.log(`è·å–ä» ${previousTag} åˆ° HEAD çš„æ‰€æœ‰æäº¤ï¼ˆå…± ${commitCount} ä¸ªï¼‰`);
              gitLogCmd = `git log ${previousTag}..HEAD --pretty=format:"%h|%s|%an|%ar"`;
            } else {
              console.log('æœªæ‰¾åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Œè·å–æœ€è¿‘ 20 æ¡æäº¤');
              gitLogCmd = 'git log -20 --pretty=format:"%h|%s|%an|%ar"';
            }

            const commits = execSync(gitLogCmd, { encoding: 'utf-8' })
              .split('\n')
              .filter(line => line.trim())
              .map(line => {
                const [hash, subject, author, date] = line.split('|');
                return { hash, subject, author, date };
              });

            console.log(`å®é™…è·å–åˆ° ${commits.length} ä¸ªæäº¤è®°å½•`);

            // å¦‚æœæ²¡æœ‰ API Keyï¼Œä½¿ç”¨é»˜è®¤æ€»ç»“
            if (!process.env.MODELSCOPE_API_KEY) {
              console.log('æœªé…ç½® MODELSCOPE_API_KEYï¼Œä½¿ç”¨é»˜è®¤æ€»ç»“');
              const summary = previousTag
                ? `æœ¬æ¬¡ç‰ˆæœ¬ä» ${previousTag} æ›´æ–°ï¼ŒåŒ…å« ${commits.length} ä¸ªæäº¤ï¼Œä¸»è¦æ›´æ–°ï¼š${commits[0].subject}`
                : `æœ¬æ¬¡æ„å»ºåŒ…å« ${commits.length} ä¸ªæäº¤ï¼Œä¸»è¦æ›´æ–°ï¼š${commits[0].subject}`;
              core.setOutput('summary', summary);
              return;
            }

            // è°ƒç”¨ ModelScope API ç”Ÿæˆæ€»ç»“ï¼ˆOpenAI å…¼å®¹æ ¼å¼ï¼‰
            try {
              const response = await fetch('https://api-inference.modelscope.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${process.env.MODELSCOPE_API_KEY}`
                },
                body: JSON.stringify({
                  model: 'Qwen/Qwen2.5-Coder-32B-Instruct',  // ä½¿ç”¨é€šä¹‰åƒé—® 2.5 Coder æ¨¡å‹
                  messages: [
                    {
                      role: 'system',
                      content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è½¯ä»¶ç‰ˆæœ¬å‘å¸ƒåŠ©æ‰‹ï¼Œæ“…é•¿åˆ†æ Git æäº¤è®°å½•å¹¶ç”Ÿæˆç»“æ„åŒ–çš„ç‰ˆæœ¬å‘å¸ƒæ–‡æ¡£ã€‚'
                    },
                    {
                      role: 'user',
                      content: `è¯·åˆ†æä»¥ä¸‹ Git æäº¤è®°å½•ï¼Œç”Ÿæˆç»“æ„åŒ–çš„ç‰ˆæœ¬å‘å¸ƒæ–‡æ¡£ã€‚

              æäº¤è®°å½•ï¼ˆå…± ${commits.length} ä¸ªï¼‰ï¼š
              ${commits.map(c => `- ${c.subject} (${c.author}, ${c.date})`).join('\n')}
            
              è¦æ±‚ï¼š
                1. ç”¨ä¸­æ–‡è¾“å‡º
                2. æŒ‰ç…§ä»¥ä¸‹æ ¼å¼åˆ†ç±»è¾“å‡ºï¼š

            ### âœ¨ æ–°å¢ï¼ˆAddedï¼‰
            - æ–°å¢çš„åŠŸèƒ½æˆ–ç‰¹æ€§
  
            ### ğŸ”§ å˜æ›´ï¼ˆChangedï¼‰
            - è¡Œä¸ºè°ƒæ•´ã€é‡æ„ã€é…ç½®å˜æ›´ç­‰
  
            ### ğŸ› ä¿®å¤ï¼ˆFixedï¼‰
            - Bug ä¿®å¤ã€é—®é¢˜è§£å†³ç­‰
  
            ### âš ï¸ åºŸå¼ƒï¼ˆDeprecatedï¼‰
            - å³å°†åºŸå¼ƒçš„åŠŸèƒ½ï¼ˆå¦‚æœæœ‰ï¼‰
  
            ### ğŸ“ å¤‡æ³¨ï¼ˆNotesï¼‰
            - é‡è¦çš„ä½¿ç”¨æ³¨æ„äº‹é¡¹æˆ–å…¼å®¹æ€§è¯´æ˜ï¼ˆå¦‚æœæœ‰ï¼‰
  
            3. **é‡è¦**ï¼šå¦‚æœæŸä¸ªåˆ†ç±»æ²¡æœ‰å†…å®¹ï¼Œå®Œå…¨çœç•¥è¯¥åˆ†ç±»çš„æ ‡é¢˜å’Œå†…å®¹ï¼Œä¸è¦è¾“å‡º"ï¼ˆæ— ï¼‰"
            4. æ¯ä¸ªè¦ç‚¹ç®€æ´æ˜äº†ï¼Œä¸è¶…è¿‡ 30 å­—
            5. åˆå¹¶ç›¸ä¼¼çš„æäº¤
            6. çªå‡ºé‡è¦å˜æ›´
            7. åªè¾“å‡ºæœ‰å†…å®¹çš„åˆ†ç±»å’Œè¦ç‚¹ï¼Œä¸è¦å…¶ä»–å†…å®¹`
                            }
                  ],
                  temperature: 0.7,
                  max_tokens: 1024,
                  stream: false
                })
              });

              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status} - ${errorText}`);
              }

              const data = await response.json();

              // OpenAI å…¼å®¹æ ¼å¼å“åº”
              if (data.choices && data.choices[0] && data.choices[0].message) {
                let summary = data.choices[0].message.content.trim();

                // æ¸…ç†å¯èƒ½çš„é‡å¤ "- " å‰ç¼€
                summary = summary.replace(/^- - /gm, '- ');

                console.log('AI ç”Ÿæˆçš„æ€»ç»“:');
                console.log(summary);
                console.log(`\nä½¿ç”¨çš„ tokens: è¾“å…¥=${data.usage.prompt_tokens}, è¾“å‡º=${data.usage.completion_tokens}, æ€»è®¡=${data.usage.total_tokens}`);

                core.setOutput('summary', summary);
              } else {
                throw new Error('API å“åº”æ ¼å¼å¼‚å¸¸');
              }
            } catch (error) {
              console.error('AI æ€»ç»“å¤±è´¥:', error.message);
              // å¤±è´¥æ—¶ä½¿ç”¨é»˜è®¤æ€»ç»“
              const summary = previousTag
                ? `æœ¬æ¬¡ç‰ˆæœ¬ä» ${previousTag} æ›´æ–°ï¼ŒåŒ…å« ${commits.length} ä¸ªæäº¤ï¼Œä¸»è¦æ›´æ–°ï¼š${commits[0].subject}`
                : `æœ¬æ¬¡æ„å»ºåŒ…å« ${commits.length} ä¸ªæäº¤ï¼Œä¸»è¦æ›´æ–°ï¼š${commits[0].subject}`;
              core.setOutput('summary', summary);
            }

  build:
    name: æ‰“åŒ…ç¼–è¯‘
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: linux-amd64
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
          - target: linux-amd64-v3
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
            goamd64: "v3"
          - target: linux-amd64-musl
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
          - target: linux-amd64-musl-v3
            runs_on: ubuntu-24.04
            goos: linux
            goarch: amd64
            goamd64: "v3"
          - target: linux-arm64
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm64
          - target: linux-arm64-musl
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm64
          - target: linux-armv7
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm
            goarm: "7"
          - target: linux-armv6
            runs_on: ubuntu-24.04
            goos: linux
            goarch: arm
            goarm: "6"
          - target: linux-386
            runs_on: ubuntu-24.04
            goos: linux
            goarch: "386"
          - target: darwin-amd64
            runs_on: macos-15-intel
            goos: darwin
            goarch: amd64
          - target: darwin-arm64
            runs_on: macos-15
            goos: darwin
            goarch: arm64
    runs-on: ${{ matrix.runs_on }}
    steps:
      - name: Checkout MSM ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: msm9527/msm
          ref: ${{ inputs.branch || 'main' }}
          token: ${{ secrets.MSM_REPO_TOKEN }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.5"
          check-latest: true
          cache: true
          cache-dependency-path: backend/go.sum

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: æ„å»º supervisordï¼ˆåµŒå…¥èµ„æºï¼‰
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm || '' }}
          GOAMD64: ${{ matrix.goamd64 || '' }}
          CGO_ENABLED: ${{ matrix.goos == 'darwin' && '1' || '0' }}
        run: |
          set -euo pipefail
          SUPERVISORD_COMMIT="$(head -n 1 backend/cmd/msm/.supervisord.version | tr -d '\r\n')"
          if [ -z "${SUPERVISORD_COMMIT}" ]; then
            echo "error: backend/cmd/msm/.supervisord.version ä¸ºç©º" >&2
            exit 1
          fi
          echo "supervisord commit: ${SUPERVISORD_COMMIT}"

          rm -rf /tmp/supervisord
          git clone https://github.com/ochinchina/supervisord.git /tmp/supervisord
          git -C /tmp/supervisord checkout "${SUPERVISORD_COMMIT}"

          (cd /tmp/supervisord && go build -ldflags="-s -w" -o supervisord)
          cp /tmp/supervisord/supervisord backend/cmd/msm/supervisord

      - name: æ„å»ºå‰ç«¯å¹¶å¤åˆ¶åˆ°åç«¯ï¼ˆåµŒå…¥èµ„æºï¼‰
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          npm ci --no-audit --no-fund
          npm run build

          test -d dist

          rm -rf ../backend/cmd/msm/frontend/dist
          mkdir -p ../backend/cmd/msm/frontend
          cp -r dist ../backend/cmd/msm/frontend/

      - name: ç¼–è¯‘ MSMï¼ˆäºŒè¿›åˆ¶ä¼˜åŒ–ç‰ˆï¼‰
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm || '' }}
          GOAMD64: ${{ matrix.goamd64 || '' }}
          CGO_ENABLED: ${{ matrix.goos == 'darwin' && '1' || '0' }}
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          mkdir -p dist
          cd backend
          go build -ldflags="-s -w" -o ../dist/msm ./cmd/msm
          cd ..
          chmod +x dist/msm

          # macOS éœ€è¦ä¿ç•™äºŒè¿›åˆ¶ç”¨äº Tauri æ„å»ºï¼Œç¨åå†æ‰“åŒ…
          if [ "${{ matrix.goos }}" != "darwin" ]; then
            tar -czf "dist/msm-${VERSION}-${{ matrix.target }}.tar.gz" -C dist msm
            rm -f dist/msm
          fi

      # macOS æ¡Œé¢åº”ç”¨æ„å»º
      - name: Setup Rust (macOS only)
        if: matrix.goos == 'darwin'
        uses: dtolnay/rust-toolchain@stable

      - name: æ„å»º Tauri æ¡Œé¢åº”ç”¨ (macOS only)
        if: matrix.goos == 'darwin'
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"

          export TAURI_APP_VERSION="${VERSION}"
          export TAURI_BUILD_VERSION="${VERSION}"

          cd frontend

          # å®‰è£…å‰ç«¯ä¾èµ–ï¼ˆç¡®ä¿ Tauri æ„å»ºç¯å¢ƒï¼‰
          npm ci --no-audit --no-fund

          WORKSPACE="$PWD"
          SRC_TAURI_DIR="$WORKSPACE/src-tauri"
          DIST_ROOT="$WORKSPACE/../dist"

          # ç¡®ä¿ç›®å½•å­˜åœ¨ï¼›å¦‚å­˜åœ¨å¼€å‘ç”¨çš„ msm å¯æ‰§è¡Œæ–‡ä»¶æˆ–ç›®å½•ï¼Œå…ˆç§»é™¤
          mkdir -p "$SRC_TAURI_DIR"
          if [ -e "$SRC_TAURI_DIR/msm" ] || [ -L "$SRC_TAURI_DIR/msm" ]; then
            rm -rf "$SRC_TAURI_DIR/msm"
          fi

          # ç›´æ¥å¤åˆ¶å·²ç¼–è¯‘çš„äºŒè¿›åˆ¶åˆ° src-tauri/msmï¼ˆä½œä¸ºæ–‡ä»¶ï¼Œä¸æ˜¯ç›®å½•ï¼‰
          cp "$DIST_ROOT/msm" "$SRC_TAURI_DIR/msm"
          chmod +x "$SRC_TAURI_DIR/msm"

          # å¤åˆ¶å¿…è¦çš„èµ„æºæ–‡ä»¶
          cp about.html dist/ || true
          cp icon.png dist/ || true

          # ä¸´æ—¶ä¿®æ”¹ tauri.conf.jsonï¼Œè·³è¿‡ beforeBuildCommandï¼ˆå‰ç«¯å·²æ„å»ºï¼‰
          TAURI_CONF="$SRC_TAURI_DIR/tauri.conf.json"
          cp "$TAURI_CONF" "$TAURI_CONF.backup"
          sed -i.tmp 's/"beforeBuildCommand":[^,]*,/"beforeBuildCommand": "echo Skipping frontend build",/' "$TAURI_CONF"

          # ä½¿ç”¨ Tauri æ„å»º DMG
          npm run tauri build

          # æ¢å¤åŸå§‹é…ç½®
          mv "$TAURI_CONF.backup" "$TAURI_CONF"

          # å¤åˆ¶ DMG åˆ° dist ç›®å½•
          mkdir -p "$DIST_ROOT"
          cp "$SRC_TAURI_DIR/target/release/bundle/dmg"/*.dmg "$DIST_ROOT/msm-desktop-${VERSION}-${{ matrix.target }}.dmg"

          # æ‰“åŒ…äºŒè¿›åˆ¶ tar.gz
          cd "$DIST_ROOT"
          tar -czf "msm-${VERSION}-${{ matrix.target }}.tar.gz" msm
          rm -f msm

          ls -l "$DIST_ROOT"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© - äºŒè¿›åˆ¶ (macOS)
        if: matrix.goos == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist/msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.tar.gz
          if-no-files-found: error

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© - DMG (macOS)
        if: matrix.goos == 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: msm-desktop-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist/msm-desktop-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.dmg
          if-no-files-found: error

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© (Linux)
        if: matrix.goos != 'darwin'
        uses: actions/upload-artifact@v4
        with:
          name: msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}
          path: dist/msm-${{ needs.prepare.outputs.version }}-${{ matrix.target }}.tar.gz
          if-no-files-found: error

  release:
    name: å‘å¸ƒæ¯æ—¥æ„å»º
    needs: [prepare, build]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout å½“å‰ä»“åº“ï¼ˆmsm-wikiï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: åˆ›å»º/æ›´æ–°ç‰ˆæœ¬ tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"
          SHA="${GITHUB_SHA}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # åˆ é™¤æ—§çš„ç‰ˆæœ¬ tagï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          git tag -d "${VERSION}" >/dev/null 2>&1 || true
          git push origin ":refs/tags/${VERSION}" || true

          # åˆ›å»ºæ–°çš„ç‰ˆæœ¬ tag
          git tag -a "${VERSION}" -m "æ¯æ—¥æ„å»º ${VERSION}" "${SHA}"
          git push origin "refs/tags/${VERSION}"

      - name: åˆ›å»º/æ›´æ–° GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.prepare.outputs.version }}
          name: ğŸš€ MSM ${{ needs.prepare.outputs.version }}
          body: |
            <div align="center">

            # ğŸ“¦ MSM ${{ needs.prepare.outputs.version }}

            ![Build Status](https://img.shields.io/badge/build-passing-brightgreen)
            ![Version](https://img.shields.io/badge/version-${{ needs.prepare.outputs.version }}-blue)
            ![Platform](https://img.shields.io/badge/platform-linux%20%7C%20macos-lightgrey)

            **æ¯æ—¥è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ Â· åŒ…å«æœ€æ–°ä»£ç æ›´æ–°**

            </div>

            ---

            ## âœ¨ æœ¬æ¬¡æ›´æ–°

            ${{ needs.prepare.outputs.ai_summary }}

            ---

            ## ğŸ“‹ æ„å»ºä¿¡æ¯

            | é¡¹ç›® | å†…å®¹ |
            |------|------|
            | **ç‰ˆæœ¬å·** | `${{ needs.prepare.outputs.version }}` |
            | **æºä»“åº“** | [msm9527/msm](https://github.com/msm9527/msm) |
            | **æ„å»ºåˆ†æ”¯** | `${{ needs.prepare.outputs.branch }}` ğŸŒ¿ |
            | **æºæäº¤** | [`${{ needs.prepare.outputs.commit_sha_short }}`](https://github.com/msm9527/msm/commit/${{ needs.prepare.outputs.commit_sha }}) |
            | **æ„å»ºæ—¶é—´** | ${{ github.event.repository.updated_at }} â° |

            <details>
            <summary>ğŸ¯ æœ€æ–°æäº¤è¯¦æƒ…</summary>

            **${{ needs.prepare.outputs.commit_message }}**

            - ğŸ‘¤ ä½œè€…: ${{ needs.prepare.outputs.commit_author }}
            - ğŸ“… æ—¶é—´: ${{ needs.prepare.outputs.commit_date }}
            - ğŸ”— é“¾æ¥: https://github.com/msm9527/msm/commit/${{ needs.prepare.outputs.commit_sha }}

            </details>

            <details>
            <summary>ğŸ“ è¿‘æœŸæ›´æ–°è®°å½•ï¼ˆæœ€è¿‘ 10 æ¬¡æäº¤ï¼‰</summary>

            ${{ needs.prepare.outputs.changelog }}

            </details>

            ---

            ## ğŸ’¾ ä¸‹è½½å®‰è£…

            ### ğŸ–¥ï¸ å‘½ä»¤è¡Œç‰ˆæœ¬ï¼ˆCLIï¼‰

            <details open>
            <summary><b>Linux å¹³å°</b></summary>

            | æ¶æ„ | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | **amd64** | [`msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz) | æ ‡å‡†ç‰ˆæœ¬ï¼ˆæ¨èï¼‰ |
            | **amd64-v3** | [`msm-${{ needs.prepare.outputs.version }}-linux-amd64-v3.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64-v3.tar.gz) | ä¼˜åŒ–ç‰ˆï¼ˆéœ€ AVX2ï¼‰ |
            | **amd64-musl** | [`msm-${{ needs.prepare.outputs.version }}-linux-amd64-musl.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64-musl.tar.gz) | Alpine Linux |
            | **amd64-musl-v3** | [`msm-${{ needs.prepare.outputs.version }}-linux-amd64-musl-v3.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64-musl-v3.tar.gz) | Alpine ä¼˜åŒ–ç‰ˆ |
            | **arm64** | [`msm-${{ needs.prepare.outputs.version }}-linux-arm64.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-arm64.tar.gz) | ARM 64ä½ |
            | **arm64-musl** | [`msm-${{ needs.prepare.outputs.version }}-linux-arm64-musl.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-arm64-musl.tar.gz) | ARM Alpine |
            | **armv7** | [`msm-${{ needs.prepare.outputs.version }}-linux-armv7.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-armv7.tar.gz) | ARM v7 |
            | **armv6** | [`msm-${{ needs.prepare.outputs.version }}-linux-armv6.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-armv6.tar.gz) | ARM v6 |
            | **386** | [`msm-${{ needs.prepare.outputs.version }}-linux-386.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-386.tar.gz) | 32ä½ x86 |

            > **ğŸ’¡ æç¤ºï¼š** amd64-v3 ç‰ˆæœ¬é’ˆå¯¹è¾ƒæ–°çš„ CPU è¿›è¡Œäº†ä¼˜åŒ–ï¼ˆéœ€è¦æ”¯æŒ AVXã€AVX2 ç­‰æŒ‡ä»¤é›†ï¼‰ï¼Œæ€§èƒ½æ›´å¥½ä½†å…¼å®¹æ€§è¾ƒä½ã€‚å¦‚æœä¸ç¡®å®šï¼Œè¯·ä½¿ç”¨æ ‡å‡†çš„ amd64 ç‰ˆæœ¬ã€‚

            </details>

            <details>
            <summary><b>macOS å¹³å°</b></summary>

            | æ¶æ„ | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | **Intel** | [`msm-${{ needs.prepare.outputs.version }}-darwin-amd64.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-darwin-amd64.tar.gz) | Intel èŠ¯ç‰‡ Mac |
            | **Apple Silicon** | [`msm-${{ needs.prepare.outputs.version }}-darwin-arm64.tar.gz`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-darwin-arm64.tar.gz) | M1/M2/M3 èŠ¯ç‰‡ |

            </details>

            ### ğŸ–¼ï¸ æ¡Œé¢åº”ç”¨ç‰ˆæœ¬ï¼ˆDesktopï¼‰

            <details>
            <summary><b>macOS æ¡Œé¢åº”ç”¨</b></summary>

            | æ¶æ„ | æ–‡ä»¶ | è¯´æ˜ |
            |------|------|------|
            | **Intel** | [`msm-desktop-${{ needs.prepare.outputs.version }}-darwin-amd64.dmg`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-desktop-${{ needs.prepare.outputs.version }}-darwin-amd64.dmg) | Intel èŠ¯ç‰‡ Mac |
            | **Apple Silicon** | [`msm-desktop-${{ needs.prepare.outputs.version }}-darwin-arm64.dmg`](https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-desktop-${{ needs.prepare.outputs.version }}-darwin-arm64.dmg) | M1/M2/M3 èŠ¯ç‰‡ |

            **å®‰è£…æ­¥éª¤ï¼š**
            1. ä¸‹è½½å¯¹åº”æ¶æ„çš„ DMG æ–‡ä»¶
            2. åŒå‡» DMG æ–‡ä»¶ï¼Œå°†åº”ç”¨æ‹–å…¥ Applications æ–‡ä»¶å¤¹
            3. é¦–æ¬¡æ‰“å¼€æ—¶ï¼Œå¦‚æœé‡åˆ°"æ— æ³•éªŒè¯å¼€å‘è€…"æç¤ºï¼š
               - æ‰“å¼€"ç³»ç»Ÿè®¾ç½®" â†’ "éšç§ä¸å®‰å…¨æ€§"
               - ç‚¹å‡»"ä»è¦æ‰“å¼€"æŒ‰é’®

            </details>

            ---

            ## ğŸš€ å¿«é€Ÿå®‰è£…

            ### ä¸€é”®å®‰è£…è„šæœ¬ï¼ˆæ¨èï¼‰

            ```bash
            curl -fsSL https://raw.githubusercontent.com/msm9527/msm-wiki/main/install.sh | sudo bash
            ```

            ### æ‰‹åŠ¨å®‰è£…ï¼ˆä»¥ Linux amd64 ä¸ºä¾‹ï¼‰

            ```bash
            # ä¸‹è½½
            wget https://github.com/msm9527/msm-wiki/releases/download/${{ needs.prepare.outputs.version }}/msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz

            # è§£å‹
            tar -xzf msm-${{ needs.prepare.outputs.version }}-linux-amd64.tar.gz

            # å®‰è£…
            sudo mv msm /usr/local/bin/msm
            sudo chmod +x /usr/local/bin/msm

            # éªŒè¯
            msm --version
            ```

            ### Docker å®‰è£…

            ```bash
            # æ‹‰å–é•œåƒ
            docker pull msmbox/msm:${{ needs.prepare.outputs.version }}

            # è¿è¡Œå®¹å™¨
            docker run -d \
              --name msm \
              -p 7777:7777 \
              -v /opt/msm:/opt/msm \
              msmbox/msm:${{ needs.prepare.outputs.version }}
            ```

            ---

            ## ğŸ“š æ–‡æ¡£ä¸æ”¯æŒ

            - ğŸ“– [å®Œæ•´æ–‡æ¡£](https://msm9527.github.io/msm-wiki/)
            - ğŸš€ [å¿«é€Ÿå¼€å§‹](https://msm9527.github.io/msm-wiki/zh/guide/install.html)
            - ğŸ“ [ç‰ˆæœ¬å‘å¸ƒ](https://msm9527.github.io/msm-wiki/zh/guide/releases.html)
            - ğŸ’¬ [é—®é¢˜åé¦ˆ](https://github.com/msm9527/msm/issues)

            ---

            <div align="center">

            **ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨æ„å»º**

            [![GitHub](https://img.shields.io/badge/GitHub-msm9527%2Fmsm-blue?logo=github)](https://github.com/msm9527/msm)
            [![Documentation](https://img.shields.io/badge/docs-msm--wiki-green)](https://msm9527.github.io/msm-wiki/)
            [![Docker](https://img.shields.io/badge/docker-msmbox%2Fmsm-blue?logo=docker)](https://hub.docker.com/r/msmbox/msm)

            </div>
          makeLatest: true
          allowUpdates: true
          replacesArtifacts: true
          artifacts: |
            dist/**/msm-${{ needs.prepare.outputs.version }}-*.tar.gz
            dist/**/msm-desktop-${{ needs.prepare.outputs.version }}-*.dmg

      - name: æ›´æ–° Wiki ç‰ˆæœ¬å‘å¸ƒé¡µé¢
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const version = '${{ needs.prepare.outputs.version }}';
            const aiSummary = `${{ needs.prepare.outputs.ai_summary }}`;
            const commitSha = '${{ needs.prepare.outputs.commit_sha_short }}';
            const commitMessage = '${{ needs.prepare.outputs.commit_message }}';
            const commitAuthor = '${{ needs.prepare.outputs.commit_author }}';
            const commitDate = '${{ needs.prepare.outputs.commit_date }}';

            // è¯»å–ç°æœ‰çš„ç‰ˆæœ¬å‘å¸ƒé¡µé¢
            const releasesPath = 'docs/zh/guide/releases.md';
            let content = fs.readFileSync(releasesPath, 'utf-8');

            // ä½¿ç”¨æœ€åä¸€ä¸ª commit çš„æ—¶é—´ä½œä¸ºå‘å¸ƒæ—¥æœŸï¼ˆç²¾ç¡®åˆ°åˆ†é’Ÿï¼‰
            // commitDate æ ¼å¼: "2026-01-09 12:34:56 +0800"
            const commitDateObj = new Date(commitDate);
            const dateStr = commitDateObj.toLocaleString('zh-CN', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              hour12: false
            }).replace(/\//g, '-');

            // æ„å»ºæ–°ç‰ˆæœ¬çš„å†…å®¹ï¼ˆä½¿ç”¨æ–°çš„ UI æ ¼å¼ï¼‰
            const newVersionContent = `
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 12px; color: white; margin: 2rem 0;">
  <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
    <div>
      <h3 style="margin: 0; color: white; font-size: 2rem;">v${version}</h3>
      <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">å‘å¸ƒæ—¥æœŸï¼š${dateStr}</p>
    </div>
    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
      <a href="https://github.com/msm9527/msm-wiki/releases/tag/${version}" target="_blank" style="background: white; color: #667eea; padding: 0.5rem 1.5rem; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
        ğŸ“¥ ä¸‹è½½
      </a>
      <a href="https://github.com/msm9527/msm-wiki/releases/tag/${version}" target="_blank" style="background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1.5rem; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-block;">
        ğŸ“ æŸ¥çœ‹è¯¦æƒ…
      </a>
    </div>
  </div>
</div>

${aiSummary}
            
            ::: details ğŸ“‹ æ„å»ºä¿¡æ¯
            - **æºæäº¤**: [\`${commitSha}\`](https://github.com/msm9527/msm/commit/${{ needs.prepare.outputs.commit_sha }})
            - **æäº¤ä¿¡æ¯**: ${commitMessage}
            - **æäº¤ä½œè€…**: ${commitAuthor}
            - **æäº¤æ—¶é—´**: ${commitDate}
            :::
            
            ---
            `;

            // æŸ¥æ‰¾"## ğŸš€ æœ€æ–°ç‰ˆæœ¬"æ ‡è®°
            const latestVersionMarker = '## ğŸš€ æœ€æ–°ç‰ˆæœ¬';
            const historyVersionMarker = '## ğŸ“š å†å²ç‰ˆæœ¬';

            if (content.includes(latestVersionMarker) && content.includes(historyVersionMarker)) {
              // æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬å’Œå†å²ç‰ˆæœ¬çš„ä½ç½®
              const latestIndex = content.indexOf(latestVersionMarker);
              const historyIndex = content.indexOf(historyVersionMarker);

              if (latestIndex !== -1 && historyIndex !== -1) {
                // ä¿ç•™æ ‡é¢˜ä¹‹å‰çš„å†…å®¹
                const beforeLatest = content.substring(0, latestIndex + latestVersionMarker.length);
                // ä¿ç•™å†å²ç‰ˆæœ¬åŠä¹‹åçš„å†…å®¹
                const afterHistory = content.substring(historyIndex);

                // é‡æ–°ç»„è£…ï¼šæ ‡é¢˜å‰ + æ ‡é¢˜ + æ–°ç‰ˆæœ¬å†…å®¹ + å†å²ç‰ˆæœ¬åŠä¹‹å
                content = beforeLatest + '\n\n' + newVersionContent + '\n' + afterHistory;
              }
            } else {
              console.log('âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬æ ‡è®°ï¼Œè·³è¿‡æ›´æ–°');
            }

            // å†™å›æ–‡ä»¶
            fs.writeFileSync(releasesPath, content, 'utf-8');

            console.log(`âœ… å·²æ›´æ–°ç‰ˆæœ¬å‘å¸ƒé¡µé¢: ${version}`);

      - name: æäº¤ Wiki æ›´æ–°
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add docs/zh/guide/releases.md

          if git diff --staged --quiet; then
            echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å‘å¸ƒé¡µé¢: ${{ needs.prepare.outputs.version }}

            - æ·»åŠ ç‰ˆæœ¬ ${{ needs.prepare.outputs.version }} çš„å‘å¸ƒä¿¡æ¯
            - AI ç”Ÿæˆçš„æ›´æ–°æ€»ç»“
            - æ„å»ºä¿¡æ¯å’Œä¸‹è½½é“¾æ¥

            Co-Authored-By: GitHub Actions <github-actions[bot]@users.noreply.github.com>"

            git push
            echo "âœ… å·²æ¨é€ Wiki æ›´æ–°"
          fi

  docker:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    needs: [prepare, release]
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout å½“å‰ä»“åº“
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: å‡†å¤‡å„æ¶æ„äºŒè¿›åˆ¶æ–‡ä»¶
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ needs.prepare.outputs.version }}"

          # åˆ›å»ºç›®å½•ç»“æ„ binaries/{platform}/msm
          mkdir -p binaries/linux/amd64 binaries/linux/arm64 binaries/linux/arm/v7 binaries/linux/arm/v6 binaries/linux/386

          # è§£å‹å¹¶å¤åˆ¶å„æ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
          echo "å‡†å¤‡ linux/amd64 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-amd64/msm-${VERSION}-linux-amd64.tar.gz" -C binaries/linux/amd64

          echo "å‡†å¤‡ linux/arm64 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-arm64/msm-${VERSION}-linux-arm64.tar.gz" -C binaries/linux/arm64

          echo "å‡†å¤‡ linux/arm/v7 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-armv7/msm-${VERSION}-linux-armv7.tar.gz" -C binaries/linux/arm/v7

          echo "å‡†å¤‡ linux/arm/v6 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-armv6/msm-${VERSION}-linux-armv6.tar.gz" -C binaries/linux/arm/v6

          echo "å‡†å¤‡ linux/386 äºŒè¿›åˆ¶..."
          tar -xzf "dist/msm-${VERSION}-linux-386/msm-${VERSION}-linux-386.tar.gz" -C binaries/linux/386

          # éªŒè¯æ–‡ä»¶ç»“æ„
          echo "éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶:"
          find binaries -name msm -exec ls -lh {} \;

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: æ„å»ºå¹¶æ¨é€å¤šæ¶æ„ Docker é•œåƒ
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.binary
          platforms: linux/amd64,linux/arm64,linux/arm/v7,linux/arm/v6,linux/386
          push: true
          tags: msmbox/msm:${{ needs.prepare.outputs.version }},msmbox/msm:latest
          labels: |
            org.opencontainers.image.title=MSM
            org.opencontainers.image.description=Mosdns Singbox Mihomo Manager
            org.opencontainers.image.version=${{ needs.prepare.outputs.version }}
            org.opencontainers.image.source=https://github.com/msm9527/msm
            org.opencontainers.image.url=https://msm9527.github.io/msm-wiki/
          provenance: false
          sbom: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
          outputs: type=image,push=true

      - name: æ˜¾ç¤ºé•œåƒä¿¡æ¯
        shell: bash
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "âœ… Docker é•œåƒå·²æ¨é€åˆ° Docker Hub"
          echo ""
          echo "é•œåƒæ ‡ç­¾:"
          echo "  - msmbox/msm:${VERSION}"
          echo "  - msmbox/msm:latest"
          echo ""
          echo "æ”¯æŒçš„æ¶æ„:"
          echo "  - linux/amd64"
          echo "  - linux/arm64"
          echo "  - linux/arm/v7"
          echo "  - linux/arm/v6"
          echo "  - linux/386"
          echo ""
          echo "æ³¨æ„: Docker é•œåƒä½¿ç”¨æ ‡å‡† amd64 ç‰ˆæœ¬ï¼Œamd64-v3 ä¼˜åŒ–ç‰ˆä»…ä½œä¸ºç‹¬ç«‹äºŒè¿›åˆ¶æ–‡ä»¶æä¾›"
          echo ""
          echo "ä½¿ç”¨æ–¹å¼:"
          echo "  docker pull msmbox/msm:latest"
          echo "  docker run -d -p 7777:7777 msmbox/msm:latest"
